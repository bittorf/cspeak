/* Copyright (C) 2009  David Roberts <d@vidr.cc>
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
 * 02110-1301, USA.
 */

#include "cspeak.h"

#include <stdio.h>
#include <math.h>
#include <stdlib.h>

typedef struct {
    unsigned char f1, f2, f3, A1, A2, A3, noise;
} formant_t;

const formant_t formants[] = {
    {0x00,0x00,0x00,0x0,0x0,0x0,0x0}, /* NUL */
    {0x0a,0x54,0x6e,0xd,0xa,0x8,0x0}, /* IY */
    {0x0e,0x49,0x5d,0xd,0x8,0x7,0x0}, /* IH */
    {0x13,0x43,0x5b,0xe,0xd,0x8,0x0}, /* EH */
    {0x18,0x3f,0x58,0xf,0xe,0x8,0x0}, /* AE */
    {0x1b,0x28,0x59,0xf,0xd,0x1,0x0}, /* AA */
    {0x17,0x2c,0x57,0xf,0xc,0x1,0x0}, /* AH */
    {0x15,0x1f,0x58,0xf,0xc,0x0,0x0}, /* AO */
    {0x10,0x25,0x52,0xf,0xb,0x1,0x0}, /* UH */
    {0x14,0x2c,0x57,0xe,0xb,0x0,0x0}, /* AX */
    {0x0e,0x49,0x5d,0xd,0xb,0x7,0x0}, /* IX */
    {0x12,0x31,0x3e,0xc,0xb,0x5,0x0}, /* ER */
    {0x0e,0x24,0x52,0xf,0xc,0x1,0x0}, /* UX */
    {0x12,0x1e,0x58,0xf,0xc,0x0,0x0}, /* OH */
    {0x12,0x33,0x3e,0xd,0xc,0x6,0x0}, /* RX */
    {0x10,0x25,0x6e,0xd,0x8,0x1,0x0}, /* LX */
    {0x0d,0x1d,0x50,0xd,0x8,0x0,0x0}, /* WX */
    {0x0f,0x45,0x5d,0xe,0xc,0x7,0x0}, /* YX */
    {0x0b,0x18,0x5a,0xd,0x8,0x0,0x0}, /* WH */
    {0x12,0x32,0x3c,0xc,0xa,0x5,0x0}, /* R */
    {0x0e,0x1e,0x6e,0xd,0x8,0x1,0x0}, /* L */
    {0x0b,0x18,0x5a,0xd,0x8,0x0,0x0}, /* W */
    {0x09,0x53,0x6e,0xd,0xa,0x8,0x0}, /* Y */
    {0x06,0x2e,0x51,0xc,0x3,0x0,0x0}, /* M */
    {0x06,0x36,0x79,0x9,0x9,0x0,0x0}, /* N */
    {0x06,0x56,0x65,0x9,0x6,0x3,0x0}, /* NX */
    {0x06,0x36,0x79,0x0,0x0,0x0,0x0}, /* DX */
    {0x11,0x43,0x5b,0x0,0x0,0x0,0x0}, /* Q */
    {0x06,0x49,0x63,0x7,0xa,0xd,0xf}, /* S */
    {0x06,0x4f,0x6a,0x0,0x0,0xa,0xf}, /* SH */
    {0x06,0x1a,0x51,0x3,0x3,0x3,0xf}, /* F */
    {0x06,0x42,0x79,0x0,0x0,0x0,0x0}, /* TH */
    {0x0e,0x49,0x5d,0x0,0x0,0x0,0x0}, /* /H */
    {0x10,0x25,0x52,0x0,0x0,0x0,0x0}, /* /X */
    {0x09,0x33,0x5d,0xf,0x3,0x8,0x3}, /* Z */
    {0x0a,0x42,0x67,0xb,0x5,0x1,0x0}, /* ZH */
    {0x08,0x28,0x4c,0xb,0x3,0x0,0x3}, /* V */
    {0x0a,0x2f,0x5d,0xb,0x4,0x0,0x3}, /* DH */
    {0x06,0x4f,0x65,0x0,0x0,0x0,0x0}, /* CHa */
    {0x06,0x4f,0x65,0x0,0x0,0x0,0x0}, /* CHb */
    {0x06,0x42,0x79,0x1,0x0,0x0,0x0}, /* Ja */
    {0x05,0x42,0x79,0x1,0x0,0x0,0x0}, /* Jb */
    {0x06,0x6e,0x79,0x0,0xa,0xe,0x0}, /* Jc */
    {0x00,0x00,0x00,0x2,0x2,0x1,0x0}, /* Jd */
    {0x13,0x48,0x5a,0xe,0xe,0x9,0x0}, /* EY */
    {0x1b,0x27,0x58,0xf,0xd,0x1,0x0}, /* AY */
    {0x15,0x1f,0x58,0xf,0xc,0x0,0x0}, /* OY */
    {0x1b,0x2b,0x58,0xf,0xd,0x1,0x0}, /* AW */
    {0x12,0x1e,0x58,0xf,0xc,0x0,0x0}, /* OW */
    {0x0d,0x22,0x52,0xd,0x8,0x0,0x0}, /* UW */
    {0x06,0x1a,0x51,0x2,0x0,0x0,0x0}, /* Ba */
    {0x06,0x1a,0x51,0x4,0x1,0x0,0xf}, /* Bb */
    {0x06,0x1a,0x51,0x0,0x0,0x0,0x0}, /* Bc */
    {0x06,0x42,0x79,0x2,0x0,0x0,0x0}, /* Da */
    {0x06,0x42,0x79,0x4,0x1,0xa,0xf}, /* Db */
    {0x06,0x42,0x79,0x0,0x0,0x0,0x0}, /* Dc */
    {0x06,0x6e,0x70,0x1,0x0,0x0,0x0}, /* Ga */
    {0x06,0x6e,0x6e,0x4,0x1,0x0,0xf}, /* Gb */
    {0x06,0x6e,0x6e,0x0,0x0,0x0,0x0}, /* Gc */
    {0x06,0x54,0x5e,0x1,0x0,0x0,0x0}, /* GXa */
    {0x06,0x54,0x5e,0x4,0x1,0x0,0xf}, /* GXb */
    {0x06,0x54,0x5e,0x0,0x0,0x0,0x0}, /* GXc */
    {0x06,0x1a,0x51,0x1,0x1,0x1,0x0}, /* Pa */
    {0x06,0x1a,0x51,0xa,0xa,0xa,0xf}, /* Pb */
    {0x06,0x1a,0x51,0x0,0x0,0x0,0x0}, /* Pc */
    {0x06,0x42,0x79,0x1,0x1,0x1,0x0}, /* Ta */
    {0x06,0x42,0x79,0xa,0xa,0xa,0xf}, /* Tb */
    {0x06,0x42,0x79,0x0,0x0,0x0,0x0}, /* Tc */
    {0x06,0x6d,0x65,0x0,0x0,0x0,0x0}, /* Ka */
    {0x0a,0x56,0x65,0xc,0xa,0x7,0x0}, /* Kb */
    {0x0a,0x6d,0x70,0x0,0x0,0x0,0x0}, /* Kc */
    {0x06,0x54,0x5e,0x0,0x0,0x0,0x0}, /* KXa */
    {0x06,0x54,0x5e,0x0,0xa,0x5,0x0}, /* KXb */
    {0x06,0x54,0x5e,0x0,0x0,0x0,0x0}  /* KXc */
};

const int FRAME_LENGTH = 15; // ms
const int SAMPLE_RATE = 44100; // Hz
const int FORMANT_SCALE = 50;

int sine(unsigned int phase, unsigned int amplitude) {
    /* sinusoidal wave */
    return amplitude * sin(2*M_PI * (double)phase/0x10000);
}

int rect(unsigned int phase, unsigned int amplitude) {
    /* sqaure wave */
    if(phase < 0x8000) return  amplitude;
    else               return -amplitude;
}

int saw(unsigned int phase, unsigned int amplitude) {
    /* (reverse) sawtooth wave */
    return amplitude - phase*amplitude/0x10000;
}

void putint(int x) {
    fwrite(&x, sizeof(int), 1, stdout);
}

double midi_freq(unsigned char m) {
    /* converts a MIDI note number to a frequency */
    return 27.5 * pow(2.0, (m-21.0)/12.0);
}

void synth(const symbol_t symbol, const unsigned int num_frames,
           const unsigned char midi_note) {
    /* Synthesize the given phoneme and output it to stdout as raw 32-bit
       signed PCM */
    const formant_t formant = formants[symbol];
    const unsigned int pitch = midi_freq(midi_note);
    
    int i, t;
    int pitch_period = SAMPLE_RATE/pitch;
    
    int *chunk = malloc(sizeof(int)*pitch_period);
    for(t = 0; t < pitch_period; t++)
        chunk[t] = saw(t*pitch, 0x1000) * (
                   sine(t*formant.f1*FORMANT_SCALE, formant.A1<<14)
                 + sine(t*formant.f2*FORMANT_SCALE, formant.A2<<14)
                 + rect(t*formant.f3*FORMANT_SCALE, formant.A3<<14) );
    
    for(i = 0; i < SAMPLE_RATE*num_frames*FRAME_LENGTH/1000/pitch_period; i++)
        for(t = 0; t < pitch_period; t++)
            putint(chunk[t] + (rand()>>6)*formant.noise);
}
